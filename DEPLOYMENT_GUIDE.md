# üìã –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –î–ï–ü–õ–û–Æ –ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ì–û –ö–û–î–ê

## ‚úÖ –ß–¢–û –ë–´–õ–û –ò–°–ü–†–ê–í–õ–ï–ù–û

### –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. ‚úÖ **–£–¥–∞–ª—ë–Ω debug –≤—ã–≤–æ–¥ ENCRYPTION_KEY** - –±—ã–ª–∞ —É—Ç–µ—á–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –ª–æ–≥–∏
2. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è SSH –∫–ª—é—á–µ–π** - –∑–∞—â–∏—Ç–∞ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
3. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ SSH –æ–ø–µ—Ä–∞—Ü–∏–∏** - –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
4. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ backup –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º authorized_keys** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö
5. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö security –æ–ø–µ—Ä–∞—Ü–∏–π** - –∞—É–¥–∏—Ç
6. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π –≤ ThreadPoolExecutor** - –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å
7. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
8. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω–∞ XSS –∑–∞—â–∏—Ç–∞ –≤ —à–∞–±–ª–æ–Ω–∞—Ö** - –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
9. ‚úÖ **–î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ fetch –∑–∞–ø—Ä–æ—Å—ã** - –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å

### –£–ª—É—á—à–µ–Ω–∏—è –∫–æ–¥–∞:
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã type hints –≤–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥—Ä–æ–±–Ω—ã–µ docstrings
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤—Å–µ critical –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–µ–∑–¥–µ
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ finally –±–ª–æ–∫–∞—Ö

---

## üöÄ –®–ê–ì–ò –î–õ–Ø –î–ï–ü–õ–û–Ø

### –®–∞–≥ 1: –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Ç–µ–∫—É—â–µ–π –ë–î
```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SQLite
cp vps_manager.db vps_manager.db.backup

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è PostgreSQL/MySQL - —Å–¥–µ–ª–∞–π—Ç–µ dump
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
```bash
# –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
# - ssh_manager.py (–ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω)
# - app.py (–æ–±–Ω–æ–≤–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏ –∏ routes)
# - templates/key-deployments.html (–æ–±–Ω–æ–≤–ª–µ–Ω —à–∞–±–ª–æ–Ω)
```

### –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–ª—è –∏–Ω–¥–µ–∫—Å–æ–≤
```bash
# –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é
flask db migrate -m "Add indexes to KeyDeployment model"

# –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
flask db upgrade
```

–ï—Å–ª–∏ –º–∏–≥—Ä–∞—Ü–∏—è –Ω–µ —Å–æ–∑–¥–∞–ª–∞—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —Å–æ–∑–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é —Ñ–∞–π–ª –≤ `migrations/versions/`:

```python
# migrations/versions/XXXXX_add_indexes_to_key_deployments.py
from alembic import op
import sqlalchemy as sa

def upgrade():
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã
    op.create_index('idx_ssh_key_id', 'key_deployments', ['ssh_key_id'])
    op.create_index('idx_server_id', 'key_deployments', ['server_id'])
    op.create_index('idx_revoked_at', 'key_deployments', ['revoked_at'])
    op.create_index('idx_deployed_at', 'key_deployments', ['deployed_at'])
    op.create_index('idx_key_server_revoked', 'key_deployments', 
                    ['ssh_key_id', 'server_id', 'revoked_at'])

def downgrade():
    op.drop_index('idx_key_server_revoked', 'key_deployments')
    op.drop_index('idx_deployed_at', 'key_deployments')
    op.drop_index('idx_revoked_at', 'key_deployments')
    op.drop_index('idx_server_id', 'key_deployments')
    op.drop_index('idx_ssh_key_id', 'key_deployments')
```

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
–£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è `logs/` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:
```bash
mkdir -p logs
```

### –®–∞–≥ 5: –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
```bash
# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è gunicorn
systemctl restart gunicorn

# –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Flask dev —Å–µ—Ä–≤–µ—Ä
# –ü—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
```

### –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É `/key-deployments`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á —Å –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ `logs/vps_manager.log`

---

## üìä –ü–†–û–í–ï–†–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –ª–æ–≥–∏—Ä—É—é—Ç—Å—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:

```bash
tail -f logs/vps_manager.log
```

–í—ã –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å –ª–æ–≥–∏ –≤—Ä–æ–¥–µ:
```
2025-10-31 15:30:45 INFO: –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ SSH –∫–ª—é—á–∞ —Ç–∏–ø–∞: rsa
2025-10-31 15:30:46 INFO: SSH –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (rsa)
2025-10-31 15:30:47 INFO: SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å 192.168.1.10:22
2025-10-31 15:30:48 INFO: –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∞ 192.168.1.10
```

---

## üîí –ü–†–û–í–ï–†–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ debug –≤—ã–≤–æ–¥ —É–¥–∞–ª—ë–Ω
```bash
grep -n "DEBUG" app.py
# –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ ENCRYPTION_KEY –Ω–µ –≤—ã–≤–æ–¥–∏—Ç—Å—è
```bash
grep -n "ENCRYPTION_KEY" app.py
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–µ –≤—ã–≤–æ–¥
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ SSH –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
```bash
grep -n "logger" ssh_manager.py | wc -l
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–π
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–º–µ—é—Ç type hints
```bash
grep -n "def " ssh_manager.py | grep -v " ->"
# –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å type hints)
```

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ó–ê–ú–ï–ß–ê–ù–ò–Ø

1. **ENCRYPTION_KEY** - —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `.env`:
   ```
   ENCRYPTION_KEY=<–≤–∞—à-fernet-–∫–ª—é—á>
   ```

2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ª–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `logs/vps_manager.log` —Å —Ä–æ—Ç–∞—Ü–∏–µ–π (10 —Ñ–∞–π–ª–æ–≤ –ø–æ 10KB)

3. **–¢–∞–π–º–∞—É—Ç—ã** - SSH –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–º–µ—é—Ç —Ç–∞–π–º–∞—É—Ç—ã:
   - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: 15 —Å–µ–∫
   - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: 20 —Å–µ–∫
   - –ë–∞–Ω–Ω–µ—Ä: 30 —Å–µ–∫
   - –û—Ç–∑—ã–≤ —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤: 300 —Å–µ–∫ (5 –º–∏–Ω—É—Ç)

4. **Backup** - –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∫–ª—é—á–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è backup `~/.ssh/authorized_keys.bak`

5. **–ò–Ω–¥–µ–∫—Å—ã** - –¥–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ `key_deployments`

---

## üß™ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï

### –¢–µ—Å—Ç 1: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞
```bash
curl -X POST http://localhost:5000/keys/generate \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "name=test-key&key_type=rsa"
```

### –¢–µ—Å—Ç 2: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª—é—á–∞
```bash
curl -X POST http://localhost:5000/keys/deploy \
  -H "Content-Type: application/json" \
  -H "X-CSRF-TOKEN: <csrf-token>" \
  -d '{"key_id": 1, "server_id": 1}'
```

### –¢–µ—Å—Ç 3: –û—Ç–∑—ã–≤ –∫–ª—é—á–∞
```bash
curl -X POST http://localhost:5000/key-deployments/revoke \
  -H "Content-Type: application/json" \
  -H "X-CSRF-TOKEN: <csrf-token>" \
  -d '{"key_id": 1, "server_id": 1}'
```

---

## üìù –§–ê–ô–õ–´ –ö–û–¢–û–†–´–ï –ë–´–õ–ò –ò–ó–ú–ï–ù–ï–ù–´

1. **ssh_manager.py** - –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º:
   - Type hints
   - –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
   - –í–∞–ª–∏–¥–∞—Ü–∏–∏
   - –¢–∞–π–º–∞—É—Ç–æ–≤
   - Backup —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

2. **app.py** - –æ–±–Ω–æ–≤–ª–µ–Ω—ã:
   - –£–¥–∞–ª–µ–Ω debug –≤—ã–≤–æ–¥ ENCRYPTION_KEY
   - –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –≤ KeyDeployment –º–æ–¥–µ–ª—å
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ ENCRYPTION_KEY

3. **templates/key-deployments.html** - –æ–±–Ω–æ–≤–ª–µ–Ω:
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ XSS –∑–∞—â–∏—Ç–∞ (|escape)
   - –î–æ–±–∞–≤–ª–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –Ω–∞ fetch
   - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

---

## ‚ú® –†–ï–ó–£–õ–¨–¢–ê–¢

–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è:
- ‚úÖ –í—Å–µ SSH –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã
- ‚úÖ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- ‚úÖ –ù–µ—Ç —É—Ç–µ—á–µ–∫ —Å–µ–∫—Ä–µ—Ç–æ–≤
- ‚úÖ –ù–µ—Ç XSS —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- ‚úÖ –•–æ—Ä–æ—à–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î
- ‚úÖ –ù–∞–¥—ë–∂–Ω—ã–µ —Ç–∞–π–º–∞—É—Ç—ã
- ‚úÖ Backup –ø–µ—Ä–µ–¥ –æ–ø–∞—Å–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏

---

## üÜò –ï–°–õ–ò –ß–¢–û-–¢–û –ü–û–®–õ–û –ù–ï –¢–ê–ö

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f logs/vps_manager.log`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ ENCRYPTION_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã: `flask db current`
4. –û—Ç–∫–∞—Ç–∏—Ç–µ—Å—å –Ω–∞ backup –ë–î –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 31 –æ–∫—Ç—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 2.0 (—Å –ø–æ–ª–Ω—ã–º –∞—É–¥–∏—Ç–æ–º –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏)
