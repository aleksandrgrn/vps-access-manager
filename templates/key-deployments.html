{% extends 'base.html' %}

{% block title %}Распределение ключей - VPS Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Модальное окно УСПЕХА -->
    <div class="modal fade" id="revokeSuccessModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Успешно!
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 id="successMessage"></h5>
                    <p id="successDetails" class="text-muted"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно с диагностикой ошибки -->
    <div class="modal fade" id="revokeErrorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Ошибка при отзыве ключа
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Основная ошибка -->
                    <div class="alert alert-danger mb-3">
                        <strong id="errorMessage"></strong>
                    </div>

                    <!-- Проблема -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <i class="bi bi-question-circle"></i> <strong>Что произошло?</strong>
                        </div>
                        <div class="card-body" id="problemDiv">
                            <!-- Заполняется JS -->
                        </div>
                    </div>

                    <!-- Возможные причины -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <i class="bi bi-search"></i> <strong>Возможные причины:</strong>
                        </div>
                        <div class="card-body">
                            <ul id="reasonsList" style="margin: 0;">
                                <!-- Заполняется JS -->
                            </ul>
                        </div>
                    </div>

                    <!-- Рекомендации -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <i class="bi bi-lightbulb"></i> <strong>Что делать?</strong>
                        </div>
                        <div class="card-body" id="solutionDiv">
                            <!-- Заполняется JS -->
                        </div>
                    </div>

                    <!-- Информация о сервере -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <i class="bi bi-info-circle"></i> <strong>Информация о сервере:</strong>
                        </div>
                        <div class="card-body" id="serverInfoDiv" style="font-size: 12px;">
                            <!-- Заполняется JS -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Закрыть
                    </button>
                    <button type="button" class="btn btn-primary" id="retryRevokeBtn">
                        <i class="bi bi-arrow-repeat"></i> Попробовать снова
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Распределение SSH-ключей</h1>
    </div>

    <!-- ФИЛЬТРЫ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <label>Фильтр по ключу:</label>
            <select id="keyFilter" class="form-select">
                <option value="">Все ключи</option>
                {% for key in all_keys %}
                <option value="{{ key.id }}">{{ key.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label>Фильтр по серверу:</label>
            <select id="serverFilter" class="form-select">
                <option value="">Все серверы</option>
                {% for server in all_servers %}
                <option value="{{ server.id }}">{{ server.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label>Статус:</label>
            <select id="statusFilter" class="form-select">
                <option value="">Все</option>
                <option value="active">Активные</option>
                <option value="revoked">Отозванные</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button onclick="applyFilters()" class="btn btn-primary w-100">
                <i class="bi bi-funnel"></i> Применить
            </button>
        </div>
    </div>

    <!-- ТАБЛИЦА -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Название ключа</th>
                            <th>Тип</th>
                            <th>Сервер</th>
                            <th>IP Адрес</th>
                            <th>Дата развёртывания</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="deploymentsTable">
                        {% for deployment in deployments %}
                        <tr>
                            <td>{{ deployment.ssh_key.name|escape }}</td>
                            <td><span class="badge bg-info text-dark">{{ deployment.ssh_key.key_type|upper }}</span>
                            </td>
                            <td>{{ deployment.server.name|escape }}</td>
                            <td>{{ deployment.server.ip_address|escape }}</td>
                            <td>{{ deployment.deployed_at.strftime('%Y-%m-%d %H:%M:%S') if deployment.deployed_at else
                                'N/A' }}</td>
                            <td>
                                {% if deployment.revoked_at %}
                                <span class="badge bg-danger">Отозван</span>
                                {% else %}
                                <span class="badge bg-success">Активен</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if not deployment.revoked_at %}
                                <button class="btn btn-sm btn-danger"
                                    onclick="openRevokeModal('{{ deployment.id }}', '{{ deployment.ssh_key.name }}', '{{ deployment.server.name }}')">
                                    <i class="bi bi-trash"></i> Отозвать
                                </button>
                                {% else %}
                                <span class="text-muted">Отозван</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4">Нет развёрнутых ключей.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения отзыва одного ключа -->
    <div class="modal fade" id="singleRevokeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        ⚠️ Отозвать доступ?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Вы уверены что хотите отозвать ключ <b><span id="revokeKeyName"></span></b>
                        с сервера <b><span id="revokeServerName"></span></b>?
                    </p>

                    <!-- Блок для отображения результата (скрыт по умолчанию) -->
                    <div id="revokeResult" class="alert d-none mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="singleRevokeCloseBtn">
                        Закрыть
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmRevokeBtn" onclick="confirmRevoke()">
                        <i class="bi bi-trash"></i> Отозвать
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentDeploymentId = null;

    /**
     * Открывает модальное окно подтверждения отзыва ключа.
     * @param {string} deploymentId - ID развертывания ключа
     * @param {string} keyName - Название ключа
     * @param {string} serverName - Название сервера
     */
    function openRevokeModal(deploymentId, keyName, serverName) {
        // Сохраняем ID для последующего удаления
        currentDeploymentId = deploymentId;

        // Заполняем данные в модалке
        document.getElementById('revokeKeyName').textContent = keyName;
        document.getElementById('revokeServerName').textContent = serverName;

        // Скрываем результат и показываем кнопку "Отозвать"
        document.getElementById('revokeResult').classList.add('d-none');
        document.getElementById('confirmRevokeBtn').classList.remove('d-none');

        // Открываем модалку
        const modal = new bootstrap.Modal(document.getElementById('singleRevokeModal'));
        modal.show();
    }

    /**
     * Подтверждает и выполняет отзыв ключа.
     */
    function confirmRevoke() {
        const resultDiv = document.getElementById('revokeResult');
        const confirmBtn = document.getElementById('confirmRevokeBtn');
        const cancelBtn = document.getElementById('singleRevokeCloseBtn');
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Показываем индикатор загрузки
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Отзыв...';

        // Таймаут на fetch запрос: 30 секунд
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000);

        fetch('/api/key-deployments/revoke', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': csrfToken
            },
            body: JSON.stringify({
                deployment_id: currentDeploymentId
            }),
            signal: controller.signal
        })
            .then(response => {
                clearTimeout(timeoutId);
                if (response.status === 500) {
                    return response.json();
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // ✅ УСПЕХ - показываем зеленый alert внутри модалки
                    resultDiv.className = 'alert alert-success mt-3';
                    const serverInfo = data.server_name && data.server_ip
                        ? ` с сервера: ${data.server_name} (${data.server_ip})`
                        : '';
                    resultDiv.innerHTML = `✅ Успешно отозвано${serverInfo}`;
                    resultDiv.classList.remove('d-none');

                    // Скрываем кнопку "Отозвать"
                    confirmBtn.classList.add('d-none');

                    // Добавляем перезагрузку страницы при закрытии
                    cancelBtn.setAttribute('onclick', 'location.reload()');

                    // Модалка остается открытой, юзер закроет сам
                } else {
                    // ❌ ОШИБКА - показываем красный alert внутри модалки
                    resultDiv.className = 'alert alert-danger mt-3';
                    resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ${escapeHtml(data.message || 'Ошибка при отзыве ключа')}`;
                    resultDiv.classList.remove('d-none');

                    // Возвращаем кнопку в исходное состояние
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="bi bi-trash"></i> Отозвать';
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);

                // Показываем ошибку в модалке
                resultDiv.className = 'alert alert-danger mt-3';
                if (error.name === 'AbortError') {
                    resultDiv.innerHTML = '<i class="bi bi-exclamation-triangle"></i> ❌ Таймаут при отзыве ключа (превышено 30 секунд)';
                } else {
                    resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> ❌ Ошибка: ${escapeHtml(error.message || error)}`;
                }
                resultDiv.classList.remove('d-none');

                // Возвращаем кнопку в исходное состояние
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="bi bi-trash"></i> Отозвать';

                console.error('Ошибка при отзыве ключа:', error);
            });
    }

    /**
     * Показывает модальное окно с детальной диагностикой ошибки (ЯКОРЬ #3)
     * @param {Object} data - Данные ошибки от сервера
     */
    function showRevokeError(data) {
        const modal = new bootstrap.Modal(document.getElementById('revokeErrorModal'));

        // Заполнить основное сообщение об ошибке
        document.getElementById('errorMessage').innerHTML = `
        <i class="bi bi-exclamation-triangle"></i> ${escapeHtml(data.message || 'Неизвестная ошибка')}
        <br><small class="text-danger">⚠️ ВНИМАНИЕ: Ключ НЕ был удалён с VPS!</small>
    `;

        // Заполнить описание проблемы
        const problemText = data.details || data.message || 'Не удалось выполнить SSH операцию';
        document.getElementById('problemDiv').innerHTML = '<p>' + escapeHtml(problemText) + '</p>';

        // Заполнить список причин (на основе error_type)
        const reasonsList = document.getElementById('reasonsList');
        const errorType = data.error_type || 'unknown';
        let reasons = [];

        switch (errorType) {
            case 'decryption_error':
                reasons = [
                    'ENCRYPTION_KEY не установлен или неверный',
                    'Повреждённые данные в БД',
                    'Ключ доступа (access_key) не найден'
                ];
                break;
            case 'ssh_error':
            case 'ssh_exception':
                reasons = [
                    'Сервер недоступен или выключен',
                    'SSH порт закрыт файрволом',
                    'Неверные SSH параметры (порт, username)',
                    'Проблемы с сетью'
                ];
                break;
            case 'missing_access_key':
                reasons = [
                    'Для сервера не настроен root ключ доступа',
                    'Сервер был добавлен без ключа'
                ];
                break;
            default:
                reasons = ['Проверьте логи сервера для деталей'];
        }

        reasonsList.innerHTML = reasons.map(r => '<li>' + escapeHtml(r) + '</li>').join('');

        // Заполнить рекомендации
        let solution = 'Проверьте доступность сервера и попробуйте снова';
        if (errorType === 'decryption_error') {
            solution = 'Проверьте переменную окружения ENCRYPTION_KEY на сервере';
        } else if (errorType === 'ssh_error' || errorType === 'ssh_exception') {
            solution = 'Проверьте что сервер доступен: ping, SSH порт открыт, правильные учётные данные';
        } else if (errorType === 'missing_access_key') {
            solution = 'Пересоздайте сервер с правильным root ключом доступа';
        }
        document.getElementById('solutionDiv').innerHTML = '<p>' + escapeHtml(solution) + '</p>';

        // Заполнить информацию о сервере
        if (data.server && data.ip) {
            document.getElementById('serverInfoDiv').innerHTML = `
            <div class="mb-2"><strong>Сервер:</strong> ${escapeHtml(data.server)}</div>
            <div class="mb-2"><code>Адрес: ${escapeHtml(data.ip)}</code></div>
            <div><code>Тип ошибки: ${escapeHtml(errorType)}</code></div>
        `;
        } else if (data.server_info) {
            const info = data.server_info;
            document.getElementById('serverInfoDiv').innerHTML = `
            <div class="mb-2"><strong>Сервер:</strong> ${escapeHtml(info.name)}</div>
            <div class="mb-2"><code>Адрес: ${escapeHtml(info.ip)}:${info.port}</code></div>
            <div><code>Пользователь: ${escapeHtml(info.username)}</code></div>
            <div><code>Тип ошибки: ${escapeHtml(errorType)}</code></div>
        `;
        } else {
            document.getElementById('serverInfoDiv').innerHTML = `<code>Тип ошибки: ${escapeHtml(errorType)}</code>`;
        }

        modal.show();
    }

    /**
     * Показывает модальное окно успеха (зелёное) (ЯКОРЬ #3)
     * @param {Object} data - Данные успеха от сервера
     */
    function showRevokeSuccess(data) {
        const modal = new bootstrap.Modal(document.getElementById('revokeSuccessModal'));

        // Заполнить сообщение
        document.getElementById('successMessage').textContent = data.message || '✅ Ключ успешно отозван';

        // Заполнить детали
        const details = [];
        if (data.server) {
            details.push(`Сервер: ${data.server}`);
        }
        if (data.ip) {
            details.push(`IP: ${data.ip}`);
        }
        document.getElementById('successDetails').textContent = details.join(' | ');

        modal.show();
    }

    /**
     * Экранирует HTML символы для безопасного вывода
     * @param {string} text - Текст для экранирования
     * @returns {string} Экранированный текст
     */
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Инициализация обработчика кнопки "Попробовать снова"
    document.addEventListener('DOMContentLoaded', function () {
        const retryBtn = document.getElementById('retryRevokeBtn');
        if (retryBtn) {
            retryBtn.addEventListener('click', function () {
                const modal = bootstrap.Modal.getInstance(document.getElementById('revokeErrorModal'));
                if (modal) {
                    modal.hide();
                }

                // Небольшая задержка перед повторной попыткой
                setTimeout(() => revokeKey(currentDeploymentId), 500);
            });
        }
    });

    /**
     * Отзывает SSH ключ со ВСЕХ серверов одновременно.
     * @param {number} keyId - ID SSH ключа
     */
    function revokeKeyFromAllServers(keyId) {
        if (!confirm('⚠️ ВНИМАНИЕ! Вы отозовёте этот ключ СО ВСЕХ серверов одновременно!\n\nЭто действие нельзя будет отменить. Продолжить?')) {
            return;
        }

        if (!confirm('Последний шанс! Отозвать ключ со ВСЕХ серверов?')) {
            return;
        }

        const progressDiv = document.createElement('div');
        progressDiv.className = 'alert alert-warning position-fixed top-0 start-50 translate-middle-x p-3 m-3';
        progressDiv.style.zIndex = '1050';
        progressDiv.innerHTML = '<i class="bi bi-hourglass-split"></i> Отзыв ключа со всех серверов... Пожалуйста ждите...';
        document.body.appendChild(progressDiv);

        // Таймаут на fetch запрос: 5 минут (для массовых операций)
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 300000);

        fetch('/api/key-deployments/revoke', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                key_id: keyId,
                server_id: null
            }),
            signal: controller.signal
        })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                progressDiv.remove();

                if (data.success) {
                    const successCount = data.revoked || 0;
                    const totalCount = data.total || 0;

                    let message = `✅ Операция завершена!\n\n`;
                    message += `Успешно отозвано: ${successCount}/${totalCount}\n`;

                    if (data.failed && data.failed.length > 0) {
                        message += `\n⚠️ Ошибки на серверах:\n`;
                        data.failed.forEach(failure => {
                            // Экранируем вывод для безопасности
                            const serverId = String(failure.server_id || 'unknown').replace(/[<>]/g, '');
                            const errorMsg = String(failure.error || 'unknown').replace(/[<>]/g, '');
                            message += `- Сервер ID ${serverId}: ${errorMsg}\n`;
                        });
                    }

                    alert(message);
                    location.reload();
                } else {
                    alert('Критическая ошибка: ' + (data.message || 'Неизвестная ошибка'));
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                progressDiv.remove();
                if (error.name === 'AbortError') {
                    alert('Ошибка: Таймаут при отзыве ключа (превышено 5 минут)');
                } else {
                    alert('Ошибка отзыва ключа: ' + (error.message || error));
                }
                console.error('Ошибка при отзыве ключа:', error);
            });
    }

    /**
     * Применяет фильтры к таблице развертываний.
     */
    function applyFilters() {
        const keyFilter = document.getElementById('keyFilter').value;
        const serverFilter = document.getElementById('serverFilter').value;
        const statusFilter = document.getElementById('statusFilter').value;

        // Построение URL с параметрами фильтра
        const params = new URLSearchParams();
        if (keyFilter) params.append('key_id', keyFilter);
        if (serverFilter) params.append('server_id', serverFilter);
        if (statusFilter) params.append('status', statusFilter);

        // Перенаправление с параметрами
        const queryString = params.toString();
        window.location.href = queryString ? `?${queryString}` : window.location.pathname;
    }
</script>
{% endblock %}