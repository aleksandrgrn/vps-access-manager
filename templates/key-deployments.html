{% extends 'base.html' %}

{% block title %}Распределение ключей - VPS Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Модальное окно УСПЕХА -->
    <div class="modal fade" id="revokeSuccessModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-check-circle"></i> Успешно!
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 id="successMessage"></h5>
                    <p id="successDetails" class="text-muted"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                        <i class="bi bi-check"></i> OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно с диагностикой ошибки -->
    <div class="modal fade" id="revokeErrorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle"></i> Ошибка при отзыве ключа
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Основная ошибка -->
                    <div class="alert alert-danger mb-3">
                        <strong id="errorMessage"></strong>
                    </div>

                    <!-- Проблема -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <i class="bi bi-question-circle"></i> <strong>Что произошло?</strong>
                        </div>
                        <div class="card-body" id="problemDiv">
                            <!-- Заполняется JS -->
                        </div>
                    </div>

                    <!-- Возможные причины -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <i class="bi bi-search"></i> <strong>Возможные причины:</strong>
                        </div>
                        <div class="card-body">
                            <ul id="reasonsList" style="margin: 0;">
                                <!-- Заполняется JS -->
                            </ul>
                        </div>
                    </div>

                    <!-- Рекомендации -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <i class="bi bi-lightbulb"></i> <strong>Что делать?</strong>
                        </div>
                        <div class="card-body" id="solutionDiv">
                            <!-- Заполняется JS -->
                        </div>
                    </div>

                    <!-- Информация о сервере -->
                    <div class="card">
                        <div class="card-header bg-light">
                            <i class="bi bi-info-circle"></i> <strong>Информация о сервере:</strong>
                        </div>
                        <div class="card-body" id="serverInfoDiv" style="font-size: 12px;">
                            <!-- Заполняется JS -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x"></i> Закрыть
                    </button>
                    <button type="button" class="btn btn-primary" id="retryRevokeBtn">
                        <i class="bi bi-arrow-repeat"></i> Попробовать снова
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Распределение SSH-ключей</h1>
    </div>

    <!-- ФИЛЬТРЫ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <label>Фильтр по ключу:</label>
            <select id="keyFilter" class="form-select">
                <option value="">Все ключи</option>
                {% for key in all_keys %}
                <option value="{{ key.id }}">{{ key.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label>Фильтр по серверу:</label>
            <select id="serverFilter" class="form-select">
                <option value="">Все серверы</option>
                {% for server in all_servers %}
                <option value="{{ server.id }}">{{ server.name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label>Статус:</label>
            <select id="statusFilter" class="form-select">
                <option value="">Все</option>
                <option value="active">Активные</option>
                <option value="revoked">Отозванные</option>
            </select>
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button onclick="applyFilters()" class="btn btn-primary w-100">
                <i class="bi bi-funnel"></i> Применить
            </button>
        </div>
    </div>

    <!-- ТАБЛИЦА -->
    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Название ключа</th>
                            <th>Тип</th>
                            <th>Сервер</th>
                            <th>IP Адрес</th>
                            <th>Дата развёртывания</th>
                            <th>Статус</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        {# Разделяем развертывания по имени ключа #}
                        {% set user_deployments = [] %}
                        {% set root_deployments = [] %}
                        {% for d in deployments %}
                        {% if '_' in d.ssh_key.name %}
                        {% set _ = root_deployments.append(d) %}
                        {% else %}
                        {% set _ = user_deployments.append(d) %}
                        {% endif %}
                        {% endfor %}

                        {# Если вообще нет развертываний #}
                        {% if not deployments %}
                        <tr>
                            <td colspan="7" class="text-center py-4">Развернутые ключи отсутствуют.</td>
                        </tr>
                        {% endif %}

                        {# Обычные развертывания #}
                        {% for deployment in user_deployments %}
                        <tr>
                            <td>{{ deployment.ssh_key.name }}</td>
                            <td><span class="badge bg-info text-dark">{{ deployment.ssh_key.key_type.upper() }}</span>
                            </td>
                            <td>{{ deployment.server.name }}</td>
                            <td>{{ deployment.server.ip_address }}</td>
                            <td>{{ deployment.deployed_at.strftime('%Y-%m-%d %H:%M:%S') if deployment.deployed_at else
                                'N/A' }}</td>
                            <td>
                                {% if deployment.revoked_at %}
                                <span class="badge bg-secondary">Отозван</span>
                                {% else %}
                                <span class="badge bg-success">Активен</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if not deployment.revoked_at %}
                                <button class="btn btn-sm btn-danger revoke-btn"
                                    data-deployment-id="{{ deployment.id }}"
                                    data-key-name="{{ deployment.ssh_key.name }}"
                                    data-server-name="{{ deployment.server.name }}" title="Отозвать доступ">
                                    <i class="bi bi-trash me-1"></i>Отозвать
                                </button>
                                {% else %}
                                <span class="text-muted small">Отозван</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        {# Показываем сообщение, если нет ПОЛЬЗОВАТЕЛЬСКИХ ключей #}
                        <tr>
                            <td colspan="7" class="text-center py-4">Развернутые ключи отсутствуют.</td>
                        </tr>
                        {% endfor %}

                        {# Разделитель для служебных развертываний #}
                        {% if root_deployments %}
                        <tr class="table-secondary" style="cursor: pointer;" onclick="toggleRootDeploymentsSection()">
                            <td colspan="7" class="text-center py-2">
                                <i class="bi bi-chevron-right" id="rootDeploymentsIcon"></i>
                                <strong id="rootDeploymentsLabel">
                                    Показать развертывания служебных ключей ({{ root_deployments|length }})
                                </strong>
                            </td>
                        </tr>

                        {# Служебные развертывания (скрыты по умолчанию) #}
                        {% for deployment in root_deployments %}
                        <tr class="root-deployment d-none">
                            <td>{{ deployment.ssh_key.name }}</td>
                            <td><span class="badge bg-info text-dark">{{ deployment.ssh_key.key_type.upper() }}</span>
                            </td>
                            <td>{{ deployment.server.name }}</td>
                            <td>{{ deployment.server.ip_address }}</td>
                            <td>{{ deployment.deployed_at.strftime('%Y-%m-%d %H:%M:%S') if deployment.deployed_at else
                                'N/A' }}</td>
                            <td>
                                {% if deployment.revoked_at %}
                                <span class="badge bg-secondary">Отозван</span>
                                {% else %}
                                <span class="badge bg-success">Активен</span>
                                {% endif %}
                            </td>
                            <td class="text-end">
                                {% if not deployment.revoked_at %}
                                <button class="btn btn-sm btn-danger revoke-btn"
                                    data-deployment-id="{{ deployment.id }}"
                                    data-key-name="{{ deployment.ssh_key.name }}"
                                    data-server-name="{{ deployment.server.name }}" title="Отозвать доступ">
                                    <i class="bi bi-trash me-1"></i>Отозвать
                                </button>
                                {% else %}
                                <span class="text-muted small">Отозван</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Модальное окно подтверждения отзыва одного ключа -->
    <div class="modal fade" id="singleRevokeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        ⚠️ Отозвать доступ?
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Вы уверены что хотите отозвать ключ <b><span id="revokeKeyName"></span></b>
                        с сервера <b><span id="revokeServerName"></span></b>?
                    </p>

                    <!-- Блок для отображения результата (скрыт по умолчанию) -->
                    <div id="revokeResult" class="alert d-none mt-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="singleRevokeCloseBtn">
                        Закрыть
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmRevokeBtn" onclick="confirmRevoke()">
                        <i class="bi bi-trash"></i> Отозвать
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // --- Управление видимостью служебных ключей ---
    let rootDeploymentsExpanded = false;

    function toggleRootDeploymentsSection() {
        const rows = document.querySelectorAll('.root-deployment');
        const icon = document.getElementById('rootDeploymentsIcon');
        const label = document.getElementById('rootDeploymentsLabel');
        const count = rows.length;

        rootDeploymentsExpanded = !rootDeploymentsExpanded;

        rows.forEach(row => {
            if (rootDeploymentsExpanded) {
                row.classList.remove('d-none');
            } else {
                row.classList.add('d-none');
            }
        });

        if (icon && label) {
            if (rootDeploymentsExpanded) {
                icon.className = 'bi bi-chevron-down';
                label.textContent = `Скрыть развертывания служебных ключей (${count})`;
            } else {
                icon.className = 'bi bi-chevron-right';
                label.textContent = `Показать развертывания служебных ключей (${count})`;
            }
        }
    }

    // --- Логика отзыва ключей ---
    let currentDeploymentId = null;
    let revokeModal = null;

    document.addEventListener('DOMContentLoaded', function () {
        // 1. Инициализация модалки (используем правильный ID из твоего HTML - singleRevokeModal)
        const modalEl = document.getElementById('singleRevokeModal');
        if (modalEl) {
            revokeModal = new bootstrap.Modal(modalEl);
        }

        // 2. Делегирование событий для кнопок отзыва (работает для скрытых/динамических элементов)
        document.body.addEventListener('click', function (e) {
            // Ищем клик по кнопке с классом .revoke-btn
            const btn = e.target.closest('.revoke-btn');
            if (btn) {
                e.preventDefault();
                const deploymentId = btn.getAttribute('data-deployment-id');
                const keyName = btn.getAttribute('data-key-name');
                const serverName = btn.getAttribute('data-server-name');

                // Вызываем открытие модалки
                openRevokeModal(deploymentId, keyName, serverName);
            }
        });

        // 3. Обработчик кнопки подтверждения в модалке
        const confirmBtn = document.getElementById('confirmRevokeBtn');
        if (confirmBtn) {
            confirmBtn.addEventListener('click', function () {
                if (currentDeploymentId) {
                    revokeKey(currentDeploymentId);
                }
            });
        }
    });

    // Функция открытия модалки
    function openRevokeModal(deploymentId, keyName, serverName) {
        currentDeploymentId = deploymentId;

        // Обновляем тексты в модалке (проверь ID элементов в HTML!)
        const keyNameEl = document.getElementById('revokeKeyName');
        const serverNameEl = document.getElementById('revokeServerName');

        if (keyNameEl) keyNameEl.textContent = keyName;
        if (serverNameEl) serverNameEl.textContent = serverName;

        if (revokeModal) {
            revokeModal.show();
        } else {
            console.error('Revoke modal not initialized');
        }
    }

    // Функция отправки запроса на отзыв
    async function revokeKey(deploymentId) {
        const btn = document.getElementById('confirmRevokeBtn');
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Отзыв...';
        }

        try {
            const response = await fetch('/api/key-deployments/revoke', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({ deployment_id: deploymentId })
            });

            const data = await response.json();

            if (data.success) {
                if (revokeModal) revokeModal.hide();
                location.reload(); // Перезагрузка для обновления статуса
            } else {
                alert('Ошибка: ' + data.message);
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'Отозвать ключ';
                }
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Произошла ошибка при отзыве ключа');
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = 'Отозвать ключ';
            }
        }
    }
</script>
{% endblock %}