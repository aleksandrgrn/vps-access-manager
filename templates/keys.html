{% extends 'base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSH-–∫–ª—é—á–∞–º–∏ - VPS Manager{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ SSH-–∫–ª—é—á–∞–º–∏</h1>
    <div>
      <button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#generateKeyModal">
        <i class="bi bi-magic me-1"></i> –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á
      </button>
      <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#uploadKeyModal">
        <i class="bi bi-upload me-1"></i> –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á
      </button>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th>–¢–∏–ø</th>
              <th>Fingerprint (MD5)</th>
              <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
              <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody>
            {# –†–∞–∑–¥–µ–ª—è–µ–º –∫–ª—é—á–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏ —Å–ª—É–∂–µ–±–Ω—ã–µ #}
            {% set user_keys = [] %}
            {% set root_keys = [] %}
            {% for key in keys %}
            {% if '_' in key.name %}
            {% set _ = root_keys.append(key) %}
            {% else %}
            {% set _ = user_keys.append(key) %}
            {% endif %}
            {% endfor %}

            {# –û–±—ã—á–Ω—ã–µ –∫–ª—é—á–∏ #}
            {% for key in user_keys %}
            <tr id="key-{{ key.id }}">
              <td>
                {{ key.name }}
                {% if key.description %}
                <i class="bi bi-info-circle text-muted ms-1" style="cursor: pointer;" data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="{{ key.description[:100] }}{{ '...' if key.description|length > 100 else '' }}"
                  onclick="openDescriptionModal({{ key.id }}, '{{ key.name }}', `{{ key.description|replace('`', '\\`')|replace('\n', ' ') }}`)"></i>
                {% else %}
                <i class="bi bi-info-circle text-muted ms-1 opacity-25" style="cursor: pointer;"
                  onclick="openDescriptionModal({{ key.id }}, '{{ key.name }}', '')"></i>
                {% endif %}
              </td>
              <td><span class="badge bg-info text-dark">{{ key.key_type.upper() }}</span></td>
              <td>
                <code>{{ key.fingerprint }}</code><br>
                <textarea class="form-control form-control-sm mt-1" rows="2" readonly>{{ key.public_key }}</textarea>
              </td>
              <td>{{ key.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-secondary me-1 view-key-btn" data-key-id="{{ key.id }}"
                  data-key-name="{{ key.name }}" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary me-1 deploy-btn" data-key-id="{{ key.id }}"
                  data-key-name="{{ key.name }}" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
                  <i class="bi bi-send"></i>
                </button>
                <button class="btn btn-sm btn-outline-success me-1 bulk-deploy-btn" data-key-id="{{ key.id }}"
                  data-key-name="{{ key.name }}" title="–ú–∞—Å—Å–æ–≤–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ">
                  <i class="bi bi-cloud-upload"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning me-1 revoke-all-btn" data-key-id="{{ key.id }}"
                  data-key-name="{{ key.name }}" title="–û—Ç–æ–∑–≤–∞—Ç—å —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤">
                  <i class="bi bi-exclamation-triangle"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-key-btn" data-bs-toggle="modal"
                  data-bs-target="#deleteKeyModal" data-id="{{ key.id }}" title="–£–¥–∞–ª–∏—Ç—å" data-name="{{ key.name }}">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% else %}
            <tr>
              <td colspan="5" class="text-center py-4">SSH-–∫–ª—é—á–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</td>
            </tr>
            {% endfor %}

            {# –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è —Å–ª—É–∂–µ–±–Ω—ã—Ö –∫–ª—é—á–µ–π #}
            {% if root_keys %}
            <tr class="table-secondary" style="cursor: pointer;" onclick="toggleRootKeysSection()">
              <td colspan="5" class="text-center py-2">
                <i class="bi bi-chevron-right" id="rootKeysIcon"></i>
                <strong id="rootKeysLabel">–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª—é—á–∏ ({{ root_keys|length }})</strong>
              </td>
            </tr>

            {# –°–ª—É–∂–µ–±–Ω—ã–µ –∫–ª—é—á–∏ #}
            {% for key in root_keys %}
            <tr id="key-{{ key.id }}" class="root-key d-none">
              <td>
                {{ key.name }}
                {% if key.description %}
                <i class="bi bi-info-circle text-muted ms-1" style="cursor: pointer;" data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="{{ key.description[:100] }}{{ '...' if key.description|length > 100 else '' }}"
                  onclick="openDescriptionModal({{ key.id }}, '{{ key.name }}', `{{ key.description|replace('`', '\\`')|replace('\n', ' ') }}`)"></i>
                {% else %}
                <i class="bi bi-info-circle text-muted ms-1 opacity-25" style="cursor: pointer;"
                  onclick="openDescriptionModal({{ key.id }}, '{{ key.name }}', '')"></i>
                {% endif %}
              </td>
              <td><span class="badge bg-info text-dark">{{ key.key_type.upper() }}</span></td>
              <td>
                <code>{{ key.fingerprint }}</code><br>
                <textarea class="form-control form-control-sm mt-1" rows="2" readonly>{{ key.public_key }}</textarea>
              </td>
              <td>{{ key.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
              <td class="text-end">
                <button class="btn btn-sm btn-outline-secondary me-1 view-key-btn" data-key-id="{{ key.id }}"
                  data-key-name="{{ key.name }}" title="–ü—Ä–æ—Å–º–æ—Ç—Ä">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary me-1 deploy-btn" data-key-id="{{ key.id }}"
                  data-key-name="{{ key.name }}" title="–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å">
                  <i class="bi bi-send"></i>
                </button>
                <button class="btn btn-sm btn-outline-success me-1 bulk-deploy-btn" data-key-id="{{ key.id }}"
                  data-key-name="{{ key.name }}" title="–ú–∞—Å—Å–æ–≤–æ–µ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ">
                  <i class="bi bi-cloud-upload"></i>
                </button>
                <button class="btn btn-sm btn-outline-warning me-1 revoke-all-btn" data-key-id="{{ key.id }}"
                  data-key-name="{{ key.name }}" title="–û—Ç–æ–∑–≤–∞—Ç—å —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤">
                  <i class="bi bi-exclamation-triangle"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger delete-key-btn" data-bs-toggle="modal"
                  data-bs-target="#deleteKeyModal" data-id="{{ key.id }}" title="–£–¥–∞–ª–∏—Ç—å" data-name="{{ key.name }}">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Generate Key Modal -->
<div class="modal fade" id="generateKeyModal" tabindex="-1" aria-labelledby="generateKeyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('keys.generate_key') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="generateKeyModalLabel">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π SSH-–∫–ª—é—á</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {{ generate_form.hidden_tag() }}
          <div class="mb-3">
            {{ generate_form.name.label(class="form-label") }}
            {{ generate_form.name(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ generate_form.key_type.label(class="form-label") }}
            {{ generate_form.key_type(class="form-select") }}
          </div>
          <div class="mb-3">
            {{ generate_form.description.label(class="form-label") }}
            {{ generate_form.description(class="form-control", rows="3", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ª—é—á –¥–ª—è –¥–µ–ø–ª–æ—è –Ω–∞
            –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä—ã") }}
            <div class="form-text">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤)</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          {{ generate_form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Upload Key Modal -->
<div class="modal fade" id="uploadKeyModal" tabindex="-1" aria-labelledby="uploadKeyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('keys.upload_key') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadKeyModalLabel">–ó–∞–≥—Ä—É–∑–∏—Ç—å SSH-–∫–ª—é—á</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          {{ upload_form.hidden_tag() }}
          <div class="mb-3">
            {{ upload_form.name.label(class="form-label") }}
            {{ upload_form.name(class="form-control") }}
          </div>
          <div class="mb-3">
            {{ upload_form.public_key.label(class="form-label") }}
            {{ upload_form.public_key(class="form-control", rows="5") }}
          </div>
          <div class="mb-3">
            {{ upload_form.description.label(class="form-label") }}
            {{ upload_form.description(class="form-control", rows="3", placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ª—é—á —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
            –ò–≤–∞–Ω–æ–≤–∞") }}
            <div class="form-text">–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–ª—é—á–∞ (–¥–æ 500 —Å–∏–º–≤–æ–ª–æ–≤)</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          {{ upload_form.submit(class="btn btn-primary") }}
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Key Confirmation Modal -->
<div class="modal fade" id="deleteKeyModal" tabindex="-1" aria-labelledby="deleteKeyModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteKeyModalLabel">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª—é—á <strong id="keyNameToDelete"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteKeyBtn">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∫–ª—é—á–∞ -->
<div class="modal fade" id="deployKeyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>–ö–ª—é—á: <strong id="deployKeyName"></strong></p>
        <div class="mb-3">
          <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä</label>
          <select class="form-select" id="deployServerSelect" required>
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä --</option>
            {% for server in servers %}
            <option value="{{ server.id }}">{{ server.name }} ({{ server.ip_address }})</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-success" id="deployBtn">
          <i class="bi bi-send me-2"></i>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å
        </button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∑—ã–≤–∞ –∫–ª—é—á–∞ —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ -->
<div class="modal fade" id="revokeAllKeyModal" tabindex="-1" aria-labelledby="revokeAllKeyModalLabel"
  aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title" id="revokeAllKeyModalLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>–û—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å –æ—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á <strong id="revokeAllKeyName"></strong> —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤, –≥–¥–µ –æ–Ω —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç.</p>
        <div class="alert alert-info">
          <strong>–°–µ—Ä–≤–µ—Ä—ã, –≥–¥–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª—é—á:</strong>
          <ul id="revokeAllServersList" class="mb-0 mt-2">
            <!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω JavaScript -->
          </ul>
        </div>
        <div id="revokeAllProgress" style="display: none;">
          <div class="progress mb-2">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="revokeAllProgressBar"
              role="progressbar" style="width: 0%"></div>
          </div>
          <small id="revokeAllProgressText" class="text-muted">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</small>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–∑—ã–≤–∞ -->
        <div id="revokeResults" class="mt-3" style="display:none;">
          <h6>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–∑—ã–≤–∞ –∫–ª—é—á–∞:</h6>

          <!-- –£—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω–æ -->
          <div class="alert alert-success" id="revokedList" style="display:none;">
            <strong>‚úÖ –£—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω–æ (<span id="revokedCount">0</span>):</strong>
            <ul id="revokedServers" class="mb-0 mt-2"></ul>
          </div>

          <!-- –ü—Ä–æ–ø—É—â–µ–Ω–æ (–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω) -->
          <div class="alert alert-info" id="skippedRevokeList" style="display:none;">
            <strong>‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω) (<span id="skippedRevokeCount">0</span>):</strong>
            <ul id="skippedRevokeServers" class="mb-0 mt-2"></ul>
          </div>

          <!-- –û—à–∏–±–∫–∏ –æ—Ç–∑—ã–≤–∞ -->
          <div class="alert alert-danger" id="failedRevokeList" style="display:none;">
            <strong>‚ùå –û—à–∏–±–∫–∏ –æ—Ç–∑—ã–≤–∞ (<span id="failedRevokeCount">0</span>):</strong>
            <ul id="failedRevokeServers" class="mb-0 mt-2"></ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="revokeAllCancelBtn">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-danger" id="revokeAllConfirmBtn">
          <i class="bi bi-exclamation-triangle me-2"></i>–û—Ç–æ–∑–≤–∞—Ç—å –≤–µ–∑–¥–µ
        </button>
      </div>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è -->
<div class="modal fade" id="bulkDeployModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–ú–∞—Å—Å–æ–≤–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∫–ª—é—á–∞</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>–ö–ª—é—á: <strong id="bulkDeployKeyName"></strong></p>

        <!-- –ü–æ–∏—Å–∫ —Å debounce -->
        <input type="text" id="bulkServerSearch" class="form-control mb-3" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ IP..."
          oninput="debounceSearch()">

        <!-- –§–∏–ª—å—Ç—Ä—ã -->
        <div class="row mb-3">
          <div class="col-md-6">
            <select id="bulkFilterSelect" class="form-select" onchange="filterBulkServers()">
              <option value="">–§–∏–ª—å—Ç—Ä</option>
              <optgroup label="–ü–æ —Å—Ç–∞—Ç—É—Å—É">
                <option value="status:online">Online</option>
                <option value="status:offline">Offline</option>
              </optgroup>
              <optgroup label="–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" id="categoryOptgroup">
                <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∑—è—Ç—Å—è —á–µ—Ä–µ–∑ JS -->
              </optgroup>
            </select>
          </div>
          <div class="col-md-6">
            <button class="btn btn-sm btn-outline-primary" onclick="selectAllBulkServers()">
              ‚úì –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllBulkServers()">
              ‚úó –°–Ω—è—Ç—å –≤—Å–µ
            </button>
          </div>
        </div>

        <!-- –°—á—ë—Ç—á–∏–∫ -->
        <div class="alert alert-info">
          –í—ã–±—Ä–∞–Ω–æ: <strong id="bulkSelectedCount">0</strong> –∏–∑
          <strong id="bulkTotalCount">{{ servers|length }}</strong> —Å–µ—Ä–≤–µ—Ä–æ–≤
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ (max-height –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞) -->
        <div id="bulkServersList" style="max-height: 400px; overflow-y: auto;">
          {% for server in servers %}
          <div class="form-check server-item" data-server-id="{{ server.id }}" data-server-name="{{ server.name }}"
            data-server-ip="{{ server.ip_address }}" data-server-status="{{ server.status }}"
            data-categories="{{ server.categories | map(attribute='id') | list | tojson }}">
            <input class="form-check-input bulk-server-checkbox" type="checkbox" value="{{ server.id }}"
              id="bulk_server_{{ server.id }}">
            <label class="form-check-label" for="bulk_server_{{ server.id }}">
              {{ server.name }} ({{ server.ip_address }})
              {% if server.status == 'online' %}
              <span class="badge bg-success">Online</span>
              {% else %}
              <span class="badge bg-secondary">Offline</span>
              {% endif %}
            </label>
          </div>
          {% endfor %}
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
        <div id="bulkDeployProgress" class="mt-3" style="display:none;">
          <div class="progress">
            <div class="progress-bar progress-bar-striped progress-bar-animated" id="bulkProgressBar" style="width: 0%">
            </div>
          </div>
          <small id="bulkProgressText">–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ...</small>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="deploymentResults" class="mt-3" style="display:none;">
          <h6>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è:</h6>

          <!-- –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ -->
          <div class="alert alert-success" id="successList" style="display:none;">
            <strong>‚úÖ –£—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ:</strong>
            <ul id="successServers" class="mb-0"></ul>
          </div>

          <!-- –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ (—É–∂–µ –µ—Å—Ç—å) -->
          <div class="alert alert-info" id="skippedList" style="display:none;">
            <strong>‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ (–∫–ª—é—á —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω):</strong>
            <ul id="skippedServers" class="mb-0"></ul>
          </div>

          <!-- –û—à–∏–±–∫–∏ -->
          <div class="alert alert-danger" id="failedList" style="display:none;">
            <strong>‚ùå –û—à–∏–±–∫–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è:</strong>
            <ul id="failedServers" class="mb-0"></ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" id="bulkDeployBtn"
          onclick="executeBulkDeploy()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å</button>
      </div>
    </div>
  </div>
</div>

<!-- View Private Key Modal -->
<div class="modal fade" id="viewKeyModal" tabindex="-1" aria-labelledby="viewKeyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="viewKeyModalLabel">
          <i class="bi bi-key me-2"></i>–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á: <span id="viewKeyName"></span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">–ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á:</label>
          <textarea id="privateKeyContent" class="form-control font-monospace" rows="15" readonly
            style="font-size: 0.85rem;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button type="button" class="btn btn-primary" id="copyPrivateKeyBtn">
          <i class="bi bi-clipboard me-2"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Description Modal -->
<div class="modal fade" id="editDescriptionModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">–û–ø–∏—Å–∞–Ω–∏–µ –∫–ª—é—á–∞: <span id="descKeyName"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <textarea id="descriptionTextarea" class="form-control" rows="5" maxlength="500"
          placeholder="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–ª—é—á–∞..."></textarea>
        <div class="form-text mt-2">
          <span id="charCount">0</span>/500 —Å–∏–º–≤–æ–ª–æ–≤
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
        <button type="button" class="btn btn-primary" onclick="saveDescription()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  let rootKeysExpanded = false;

  function toggleRootKeysSection() {
    const rootKeys = document.querySelectorAll('.root-key');
    const icon = document.getElementById('rootKeysIcon');
    const label = document.getElementById('rootKeysLabel');
    const count = rootKeys.length;

    rootKeysExpanded = !rootKeysExpanded;

    rootKeys.forEach(row => {
      if (rootKeysExpanded) {
        row.classList.remove('d-none');
      } else {
        row.classList.add('d-none');
      }
    });

    if (rootKeysExpanded) {
      icon.className = 'bi bi-chevron-down';
      label.textContent = `–°–∫—Ä—ã—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª—é—á–∏ (${count})`;
    } else {
      icon.className = 'bi bi-chevron-right';
      label.textContent = `–ü–æ–∫–∞–∑–∞—Ç—å —Å–ª—É–∂–µ–±–Ω—ã–µ –∫–ª—é—á–∏ (${count})`;
    }
  }

  let currentEditKeyId = null;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤ Bootstrap
  document.addEventListener('DOMContentLoaded', function () {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // –°—á—ë—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤
    const textarea = document.getElementById('descriptionTextarea');
    if (textarea) {
      textarea.addEventListener('input', function () {
        document.getElementById('charCount').textContent = this.value.length;
      });
    }
  });

  function openDescriptionModal(keyId, keyName, description) {
    currentEditKeyId = keyId;
    document.getElementById('descKeyName').textContent = keyName;
    document.getElementById('descriptionTextarea').value = description || '';
    document.getElementById('charCount').textContent = (description || '').length;

    const modal = new bootstrap.Modal(document.getElementById('editDescriptionModal'));
    modal.show();
  }

  async function saveDescription() {
    if (!currentEditKeyId) return;

    const description = document.getElementById('descriptionTextarea').value.trim();
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    try {
      const response = await fetch(`/api/keys/update-description/${currentEditKeyId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({ description })
      });

      const data = await response.json();

      if (data.success) {
        alert('‚úÖ –û–ø–∏—Å–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        bootstrap.Modal.getInstance(document.getElementById('editDescriptionModal')).hide();
        location.reload();
      } else {
        alert('‚ùå ' + data.message);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    }
  }
  let currentKeyId = null;
  let deployModal = null;
  let viewKeyModal = null;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function () {
    deployModal = new bootstrap.Modal(document.getElementById('deployKeyModal'));
    viewKeyModal = new bootstrap.Modal(document.getElementById('viewKeyModal'));

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
    document.querySelectorAll('.deploy-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const keyId = this.getAttribute('data-key-id');
        const keyName = this.getAttribute('data-key-name');
        openDeployModal(keyId, keyName);
      });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    document.querySelectorAll('.view-key-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const keyId = this.getAttribute('data-key-id');
        const keyName = this.getAttribute('data-key-name');
        viewPrivateKey(keyId, keyName);
      });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('copyPrivateKeyBtn').addEventListener('click', function () {
      const privateKeyContent = document.getElementById('privateKeyContent');
      privateKeyContent.select();
      document.execCommand('copy');

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
      const originalText = this.innerHTML;
      this.innerHTML = '<i class="bi bi-check2 me-2"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      this.classList.remove('btn-primary');
      this.classList.add('btn-success');

      setTimeout(() => {
        this.innerHTML = originalText;
        this.classList.remove('btn-success');
        this.classList.add('btn-primary');
      }, 2000);
    });
  });

  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è
  function openDeployModal(keyId, keyName) {
    currentKeyId = keyId;
    document.getElementById('deployKeyName').textContent = keyName;
    if (deployModal) {
      deployModal.show();
    }
  }

  // ====== VIEW PRIVATE KEY FUNCTIONALITY ======
  async function viewPrivateKey(keyId, keyName) {
    try {
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
      document.getElementById('viewKeyName').textContent = keyName;
      document.getElementById('privateKeyContent').value = '–ó–∞–≥—Ä—É–∑–∫–∞...';

      if (viewKeyModal) {
        viewKeyModal.show();
      }

      // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
      const response = await fetch(`/api/keys/view/${keyId}`, {
        method: 'GET',
        headers: {
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
        },
        credentials: 'same-origin'
      });

      if (!response.ok) {
        let errorMessage = `HTTP error! status: ${response.status}`;
        try {
          const errorData = await response.json();
          if (errorData.message) {
            errorMessage = errorData.message;
          }
        } catch (e) {
          // ignore
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();

      if (data.success) {
        document.getElementById('privateKeyContent').value = data.private_key;
      } else {
        throw new Error(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–ª—é—á');
      }
    } catch (error) {
      console.error('Error viewing key:', error);
      document.getElementById('privateKeyContent').value = `–û—à–∏–±–∫–∞: ${error.message}`;
      alert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª—é—á–∞: ${error.message}`);
    }
  }

  // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∫–ª—é—á –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  async function deployKey() {
    console.log('1. –ù–∞—á–∞–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è deployKey()');
    const serverId = document.getElementById('deployServerSelect').value;
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

    if (!serverId) {
      const errorMsg = '–û—à–∏–±–∫–∞: –Ω–µ –≤—ã–±—Ä–∞–Ω —Å–µ—Ä–≤–µ—Ä';
      console.error(errorMsg);
      alert('‚ùå ' + errorMsg);
      return;
    }

    console.log('2. ID —Å–µ—Ä–≤–µ—Ä–∞:', serverId);
    console.log('3. ID –∫–ª—é—á–∞:', currentKeyId);

    const btn = document.getElementById('deployBtn');
    if (!btn) {
      console.error('–û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω —ç–ª–µ–º–µ–Ω—Ç #deployBtn');
      return;
    }

    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>–†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ...';

    try {
      console.log('4. –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ /keys/deploy');
      const response = await fetch('/api/keys/deploy', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken || ''
        },
        body: JSON.stringify({
          key_id: currentKeyId,
          server_id: parseInt(serverId)
        }),
        credentials: 'same-origin'
      });

      console.log('5. –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status, response.statusText);

      if (!response.ok) {
        let errorMessage = `–û—à–∏–±–∫–∞ HTTP: ${response.status}`;
        try {
          const errorData = await response.json();
          if (errorData.message) {
            errorMessage = errorData.message;
          }
        } catch (e) {
          const errorText = await response.text();
          if (errorText) errorMessage = errorText;
        }
        throw new Error(errorMessage);
      }

      const data = await response.json();
      console.log('6. –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);

      if (data.success) {
        const successMsg = data.message || '–ö–ª—é—á —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç';
        console.log('7. –£—Å–ø–µ—Ö:', successMsg);
        alert('‚úÖ ' + successMsg);

        if (deployModal) {
          deployModal.hide();
          // –î–∞–¥–∏–º –≤—Ä–µ–º—è –º–æ–¥–∞–ª—å–Ω–æ–º—É –æ–∫–Ω—É —Å–∫—Ä—ã—Ç—å—Å—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π
          setTimeout(() => location.reload(), 500);
        } else {
          location.reload();
        }
      } else {
        const errorMsg = data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        console.error('7. –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorMsg);
        alert('‚ùå –û—à–∏–±–∫–∞: ' + errorMsg);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–∏ –∫–ª—é—á–∞:', error);
      alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å'}`);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-send me-2"></i>–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
    }
  }
  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª—é—á–∞ ---
  const deleteKeyModal = document.getElementById('deleteKeyModal');
  let keyIdToDelete = null;

  deleteKeyModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    keyIdToDelete = button.getAttribute('data-id');
    const keyName = button.getAttribute('data-name');
    const modalBody = deleteKeyModal.querySelector('#keyNameToDelete');
    modalBody.textContent = keyName;
  });

  const confirmDeleteKeyBtn = document.getElementById('confirmDeleteKeyBtn');
  confirmDeleteKeyBtn.addEventListener('click', async function () {
    if (!keyIdToDelete) return;

    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª—é—á? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`)) {
      return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    try {
      const response = await fetch(`/api/keys/delete/${keyIdToDelete}`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrfToken
        }
      });
      const data = await response.json();
      if (data.success) {
        alert('‚úÖ ' + data.message);
        document.getElementById(`key-${keyIdToDelete}`).remove();
        bootstrap.Modal.getInstance(deleteKeyModal).hide();
      } else {
        alert('‚ùå ' + data.message);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞:', error);
      alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
    }
  });

  // –ü–æ–¥–∫–ª—é—á–∞–µ–º deployKey –∫ –∫–Ω–æ–ø–∫–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
  const deployBtn = document.getElementById('deployBtn');
  if (deployBtn) {
    deployBtn.addEventListener('click', deployKey);
  }

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è ---
  let currentKeyIdForBulkDeploy = null;
  let bulkDeployModal = null;
  let debounceTimer = null;

  // Debounce helper –¥–ª—è –ø–æ–∏—Å–∫–∞
  function debounceSearch() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(filterBulkServers, 300);
  }

  async function loadCategoriesForBulkDeploy() {
    try {
      const response = await fetch('/api/categories');
      const categories = await response.json();

      const optgroup = document.getElementById('categoryOptgroup');
      optgroup.innerHTML = ''; // –û—á–∏—Å—Ç–∫–∞

      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = `category:${cat.id}`;
        option.textContent = cat.name;
        optgroup.appendChild(option);
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
    }
  }

  function openBulkDeployModal(keyId, keyName) {
    currentKeyIdForBulkDeploy = keyId;
    document.getElementById('bulkDeployKeyName').textContent = keyName;
    document.getElementById('bulkSelectedCount').textContent = '0';
    document.getElementById('deploymentResults').style.display = 'none';
    // –û—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–æ–≤
    document.getElementById('successServers').innerHTML = '';
    document.getElementById('skippedServers').innerHTML = '';
    document.getElementById('failedServers').innerHTML = '';
    document.getElementById('successList').style.display = 'none';
    document.getElementById('skippedList').style.display = 'none';
    document.getElementById('failedList').style.display = 'none';
    document.getElementById('bulkDeployProgress').style.display = 'none';

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã
    document.querySelectorAll('.bulk-server-checkbox').forEach(cb => cb.checked = false);

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    document.getElementById('bulkServerSearch').value = '';
    document.getElementById('bulkFilterSelect').value = '';

    loadCategoriesForBulkDeploy();
    filterBulkServers();

    if (!bulkDeployModal) {
      bulkDeployModal = new bootstrap.Modal(document.getElementById('bulkDeployModal'));
    }
    bulkDeployModal.show();
  }

  function filterBulkServers() {
    const search = document.getElementById('bulkServerSearch').value.toLowerCase();
    const filterValue = document.getElementById('bulkFilterSelect').value;

    // –†–∞–∑–±–∏—Ä–∞–µ–º —Ñ–∏–ª—å—Ç—Ä
    let filterType = null;
    let filterVal = null;
    if (filterValue) {
      const parts = filterValue.split(':');
      filterType = parts[0]; // "status" –∏–ª–∏ "category"
      filterVal = parts[1];
    }

    let visibleCount = 0;
    document.querySelectorAll('.server-item').forEach(item => {
      const name = item.dataset.serverName.toLowerCase();
      const ip = item.dataset.serverIp.toLowerCase();
      const serverStatus = item.dataset.serverStatus;
      const serverCategories = JSON.parse(item.dataset.categories || '[]');

      const matchSearch = name.includes(search) || ip.includes(search);

      let matchFilter = true;
      if (filterType === 'status') {
        matchFilter = (serverStatus === filterVal);
      } else if (filterType === 'category') {
        matchFilter = serverCategories.includes(parseInt(filterVal));
      }

      if (matchSearch && matchFilter) {
        item.style.display = 'block';
        visibleCount++;
      } else {
        item.style.display = 'none';
      }
    });

    updateBulkSelectedCount();
  }

  function selectAllBulkServers() {
    document.querySelectorAll('.server-item:not([style*="display: none"]) .bulk-server-checkbox')
      .forEach(cb => cb.checked = true);
    updateBulkSelectedCount();
  }

  function deselectAllBulkServers() {
    document.querySelectorAll('.bulk-server-checkbox').forEach(cb => cb.checked = false);
    updateBulkSelectedCount();
  }

  function updateBulkSelectedCount() {
    const count = document.querySelectorAll('.bulk-server-checkbox:checked').length;
    document.getElementById('bulkSelectedCount').textContent = count;
  }

  async function executeBulkDeploy() {
    const selectedIds = Array.from(document.querySelectorAll('.bulk-server-checkbox:checked'))
      .map(cb => parseInt(cb.value));

    if (selectedIds.length === 0) {
      alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–µ—Ä–≤–µ—Ä');
      return;
    }

    const btn = document.getElementById('bulkDeployBtn');
    const progressDiv = document.getElementById('bulkDeployProgress');
    const resultsDiv = document.getElementById('deploymentResults');

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
    progressDiv.style.display = 'block';
    resultsDiv.style.display = 'none';
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ...';

    try {
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

      const response = await fetch('/api/keys/bulk-deploy', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken || ''
        },
        body: JSON.stringify({
          key_id: currentKeyIdForBulkDeploy,
          server_ids: selectedIds
        }),
        credentials: 'same-origin'
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      // –°–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
      progressDiv.style.display = 'none';
      displayBulkDeployResults(result);

      // –ï—Å–ª–∏ –≤—Å–µ —É—Å–ø–µ—à–Ω–æ, –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —É–±—Ä–∞–Ω–æ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏:', error);
      progressDiv.style.display = 'none';
      alert('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
    } finally {
      btn.disabled = false;
      btn.innerHTML = '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å';
    }
  }

  function displayBulkDeployResults(result) {
    const resultsDiv = document.getElementById('deploymentResults');
    resultsDiv.style.display = 'block';

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const successUl = document.getElementById('successServers');
    const skippedUl = document.getElementById('skippedServers');
    const failedUl = document.getElementById('failedServers');

    successUl.innerHTML = '';
    skippedUl.innerHTML = '';
    failedUl.innerHTML = '';

    // Helper to get IP
    const getIp = (id) => {
      const el = document.querySelector(`.server-item[data-server-id="${id}"]`);
      return el ? el.dataset.serverIp : '';
    };

    // 1. –£—Å–ø–µ—à–Ω–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–µ
    if (result.deployed && result.deployed.length > 0) {
      document.getElementById('successList').style.display = 'block';
      result.deployed.forEach(server => {
        const li = document.createElement('li');
        const ip = getIp(server.server_id);
        li.textContent = `${server.server_name} (${ip})`;
        successUl.appendChild(li);
      });
    } else {
      document.getElementById('successList').style.display = 'none';
    }

    // 2. –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ
    if (result.skipped && result.skipped.length > 0) {
      document.getElementById('skippedList').style.display = 'block';
      result.skipped.forEach(server => {
        const li = document.createElement('li');
        li.textContent = `${server.server_name} - ${server.reason}`;
        skippedUl.appendChild(li);
      });
    } else {
      document.getElementById('skippedList').style.display = 'none';
    }

    // 3. –û—à–∏–±–∫–∏
    if (result.failed && result.failed.length > 0) {
      document.getElementById('failedList').style.display = 'block';
      result.failed.forEach(server => {
        const li = document.createElement('li');
        li.textContent = `${server.server_name} - ${server.error}`;
        failedUl.appendChild(li);
      });
    } else {
      document.getElementById('failedList').style.display = 'none';
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –º–∞—Å—Å–æ–≤–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.bulk-deploy-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const keyId = this.getAttribute('data-key-id');
        const keyName = this.getAttribute('data-key-name');
        openBulkDeployModal(keyId, keyName);
      });
    });

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —á–µ–∫–±–æ–∫—Å–æ–≤
    document.querySelectorAll('.bulk-server-checkbox').forEach(cb => {
      cb.addEventListener('change', updateBulkSelectedCount);
    });
  });

  // --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∑—ã–≤–∞ –∫–ª—é—á–∞ —Å–æ –≤—Å–µ—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ ---
  let revokeAllKeyId = null;
  let revokeAllModal = null;

  document.addEventListener('DOMContentLoaded', function () {
    revokeAllModal = new bootstrap.Modal(document.getElementById('revokeAllKeyModal'));

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ "–û—Ç–æ–∑–≤–∞—Ç—å –≤–µ–∑–¥–µ"
    document.querySelectorAll('.revoke-all-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        revokeAllKeyId = this.getAttribute('data-key-id');
        const keyName = this.getAttribute('data-key-name');
        openRevokeAllModal(revokeAllKeyId, keyName);
      });
    });
  });

  function openRevokeAllModal(keyId, keyName) {
    revokeAllKeyId = keyId;
    document.getElementById('revokeAllKeyName').textContent = keyName;

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    document.getElementById('revokeResults').style.display = 'none';
    document.getElementById('revokeAllProgress').style.display = 'none';

    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
    const confirmBtn = document.getElementById('revokeAllConfirmBtn');
    const cancelBtn = document.getElementById('revokeAllCancelBtn');
    confirmBtn.style.display = '';
    confirmBtn.disabled = false;
    cancelBtn.disabled = false;
    cancelBtn.textContent = '–û—Ç–º–µ–Ω–∞';

    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≥–¥–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∫–ª—é—á
    fetchServersWithKey(keyId);

    if (revokeAllModal) {
      revokeAllModal.show();
    }
  }

  async function fetchServersWithKey(keyId) {
    try {
      const response = await fetch(`/api/key-servers/${keyId}`);
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤');
      }

      const data = await response.json();
      const serversList = document.getElementById('revokeAllServersList');
      serversList.innerHTML = '';

      if (data.servers && data.servers.length > 0) {
        data.servers.forEach(server => {
          const li = document.createElement('li');
          li.textContent = `${server.name} (${server.ip_address})`;
          serversList.appendChild(li);
        });
      } else {
        serversList.innerHTML = '<li class="text-muted">–ö–ª—é—á –Ω–µ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –Ω–∏ –Ω–∞ –æ–¥–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ</li>';
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤:', error);
      const serversList = document.getElementById('revokeAllServersList');
      serversList.innerHTML = '<li class="text-danger">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤</li>';
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ—Ç–∑—ã–≤–∞
  function displayRevokeResults(result) {
    const resultsDiv = document.getElementById('revokeResults');
    resultsDiv.style.display = 'block';

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const revokedUl = document.getElementById('revokedServers');
    const skippedUl = document.getElementById('skippedRevokeServers');
    const failedUl = document.getElementById('failedRevokeServers');

    revokedUl.innerHTML = '';
    skippedUl.innerHTML = '';
    failedUl.innerHTML = '';

    // 1. –£—Å–ø–µ—à–Ω–æ –æ—Ç–æ–∑–≤–∞–Ω–Ω—ã–µ
    if (result.revoked && result.revoked.length > 0) {
      document.getElementById('revokedList').style.display = 'block';
      document.getElementById('revokedCount').textContent = result.revoked.length;
      result.revoked.forEach(server => {
        const li = document.createElement('li');
        li.textContent = `${server.server_name} (${server.server_ip})`;
        revokedUl.appendChild(li);
      });
    } else {
      document.getElementById('revokedList').style.display = 'none';
    }

    // 2. –ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ
    if (result.skipped && result.skipped.length > 0) {
      document.getElementById('skippedRevokeList').style.display = 'block';
      document.getElementById('skippedRevokeCount').textContent = result.skipped.length;
      result.skipped.forEach(server => {
        const li = document.createElement('li');
        li.textContent = `${server.server_name} (${server.server_ip}) - ${server.reason}`;
        skippedUl.appendChild(li);
      });
    } else {
      document.getElementById('skippedRevokeList').style.display = 'none';
    }

    // 3. –û—à–∏–±–∫–∏
    if (result.failed && result.failed.length > 0) {
      document.getElementById('failedRevokeList').style.display = 'block';
      document.getElementById('failedRevokeCount').textContent = result.failed.length;
      result.failed.forEach(server => {
        const li = document.createElement('li');
        li.textContent = `${server.server_name} (${server.server_ip}) - ${server.error}`;
        failedUl.appendChild(li);
      });
    } else {
      document.getElementById('failedRevokeList').style.display = 'none';
    }
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–æ–∑–≤–∞—Ç—å –≤–µ–∑–¥–µ"
  document.getElementById('revokeAllConfirmBtn').addEventListener('click', async function () {
    if (!revokeAllKeyId) return;

    const confirmBtn = this;
    const cancelBtn = document.getElementById('revokeAllCancelBtn');
    const progressDiv = document.getElementById('revokeAllProgress');
    const progressBar = document.getElementById('revokeAllProgressBar');
    const progressText = document.getElementById('revokeAllProgressText');

    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    confirmBtn.disabled = true;
    cancelBtn.disabled = true;
    progressDiv.style.display = 'block';

    try {
      const response = await fetch('/api/revoke-key-all', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
          ssh_key_id: parseInt(revokeAllKeyId)
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ –∫–ª—é—á–∞');
      }

      const data = await response.json();

      // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞
      console.log('[REVOKE_RESULT] Full response:', data);
      console.log('[REVOKE_RESULT] Revoked:', data.revoked);
      console.log('[REVOKE_RESULT] Skipped:', data.skipped);
      console.log('[REVOKE_RESULT] Failed:', data.failed);

      if (data.success) {
        // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        progressDiv.style.display = 'none';

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        displayRevokeResults(data);

        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ (–∫—Ä–æ–º–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è - –æ–ø–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
        cancelBtn.disabled = false;
        cancelBtn.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
        confirmBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      } else {
        throw new Error(data.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∑—ã–≤–µ –∫–ª—é—á–∞:', error);
      alert(`‚ùå –û—à–∏–±–∫–∞: ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–æ–∑–≤–∞—Ç—å –∫–ª—é—á'}`);

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
      confirmBtn.disabled = false;
      cancelBtn.disabled = false;
      progressDiv.style.display = 'none';
    }
  });
</script>
{% endblock %}