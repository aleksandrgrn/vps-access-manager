{% extends 'base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏ - VPS Manager{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞–º–∏</h1>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#serverModal" data-action="add"
                data-add-url="{{ url_for('servers.add_server') }}">

                <i class="bi bi-plus-circle me-1"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
            </button>
            <button class="btn btn-secondary ms-2" data-bs-toggle="modal" data-bs-target="#manageCategoriesModal">
                <i class="bi bi-tags"></i> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
            </button>
            <button type="button" class="btn btn-success ms-2" data-bs-toggle="modal" data-bs-target="#bulkImportModal">
                <i class="bi bi-cloud-arrow-up"></i> –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç
            </button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>IP –ê–¥—Ä–µ—Å</th>
                            <th>–ü–æ—Ä—Ç</th>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th>
                            <th class="text-end">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for server in servers %}
                        <tr id="server-{{ server.id }}">
                            <td data-field="name">{{ server.name }}</td>
                            <td data-field="ip_address">{{ server.ip_address }}</td>
                            <td data-field="ssh_port">{{ server.ssh_port }}</td>
                            <td data-field="username">{{ server.username }}</td>
                            <td data-field="status"><span
                                    class="badge bg-{{ status_colors.get(server.status, 'secondary') }}">{{
                                    server.status }}</span></td>
                            <td>{{ server.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                            <td data-field="requires_legacy_ssh" class="d-none">{{ server.requires_legacy_ssh|int }}
                            </td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-outline-secondary me-1 edit-btn" data-bs-toggle="modal"
                                    data-bs-target="#serverModal" data-id="{{ server.id }}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä"
                                    data-action="edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-info me-1 test-btn" data-id="{{ server.id }}"
                                    title="–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è">
                                    <i class="bi bi-shield-check"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-bs-toggle="modal"
                                    data-bs-target="#deleteConfirmModal" data-id="{{ server.id }}"
                                    title="–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä" data-name="{{ server.name }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="text-center py-4">–°–µ—Ä–≤–µ—Ä—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Server Modal -->
<div class="modal fade" id="serverModal" tabindex="-1" aria-labelledby="serverModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="serverForm" method="POST">
                <div class="modal-header">
                    <h5 class="modal-title" id="serverModalLabel">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {{ form.hidden_tag() }}
                    <input type="hidden" id="server-id" name="server_id">
                    <div class="mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control", id="server-name") }}
                    </div>
                    <div class="mb-3">
                        {{ form.ip_address.label(class="form-label") }}
                        {{ form.ip_address(class="form-control", id="server-ip") }}
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            {{ form.ssh_port.label(class="form-label") }}
                            {{ form.ssh_port(class="form-control", id="server-port") }}
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.username.label(class="form-label") }}
                            {{ form.username(class="form-control", id="server-username") }}
                        </div>
                    </div>
                    <div class="mb-3 form-check">
                        {{ form.requires_legacy_ssh(class="form-check-input", id="server-legacy-ssh") }}
                        {{ form.requires_legacy_ssh.label(class="form-check-label", for="server-legacy-ssh") }}
                        <div class="form-text d-block">–í–∫–ª—é—á–∏—Ç–µ, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OpenSSH –≤–µ—Ä—Å–∏–∏ < 7.2. –û–±—ã—á–Ω–æ
                                –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.</div>
                        </div>
                        <div class="mb-3" id="password-field">
                            <label for="serverPassword" class="form-label">–ü–∞—Ä–æ–ª—å –¥–ª—è SSH</label>
                            <input type="password" class="form-control" id="serverPassword" name="password">
                            <div class="form-text">–ü–∞—Ä–æ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª—é—á–∞ –¥–æ—Å—Ç—É–ø–∞
                                –∏ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmModalLabel">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä <strong id="serverNameToDelete"></strong>?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ -->
<div class="modal fade" id="bulkImportModal" tabindex="-1" aria-labelledby="bulkImportLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="bulkImportLabel">
                    <i class="bi bi-cloud-arrow-up"></i> –ú–∞—Å—Å–æ–≤—ã–π –∏–º–ø–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <textarea id="bulkServersList" class="form-control" rows="10"
                    placeholder="server1.example.com ubuntu mypass123 192.168.1.10 22&#10;server2.example.com root securepass 192.168.1.11 22&#10;server3.example.com admin password456 192.168.1.12 2222"
                    style="background-color: #f8f9fa; font-family: monospace; font-size: 12px; border: 2px solid #e9ecef;"></textarea>

                <div class="alert alert-light mt-3 mb-0" id="importInstructions"
                    style="background-color: #f1f3f5; border: 1px solid #dee2e6;">
                    <small class="text-muted d-block">
                        üìã <strong>–§–æ—Ä–º–∞—Ç:</strong> domain username password ip-address ssh-port
                    </small>
                    <small class="text-muted d-block mt-1">
                        üí° –ö–∞–∂–¥—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ, –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è –ø—Ä–æ–±–µ–ª–∞–º–∏
                    </small>
                </div>

                <!-- –ë–ª–æ–∫ –æ—à–∏–±–æ–∫ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div id="importError" class="alert alert-danger mt-3" style="display:none;"></div>

                <!-- –ë–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–º–ø–æ—Ä—Ç–∞ -->
                <div id="importResults" style="display:none;" class="mt-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–º–ø–æ—Ä—Ç–∞:</h6>
                    </div>

                    <!-- Added -->
                    <div id="resultsAdded" class="mb-2" style="display:none;">
                        <div class="alert alert-success mb-1 py-2 px-3">
                            <strong>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: <span id="countAdded">0</span></strong>
                        </div>
                        <ul class="list-group list-group-flush small" id="listAdded"
                            style="max-height: 150px; overflow-y: auto;"></ul>
                    </div>

                    <!-- Skipped -->
                    <div id="resultsSkipped" class="mb-2" style="display:none;">
                        <div class="alert alert-warning mb-1 py-2 px-3">
                            <strong>‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ: <span id="countSkipped">0</span></strong>
                        </div>
                        <ul class="list-group list-group-flush small" id="listSkipped"
                            style="max-height: 150px; overflow-y: auto;"></ul>
                    </div>

                    <!-- Failed -->
                    <div id="resultsFailed" class="mb-2" style="display:none;">
                        <div class="alert alert-danger mb-1 py-2 px-3">
                            <strong>‚ùå –û—à–∏–±–∫–∏: <span id="countFailed">0</span></strong>
                        </div>
                        <ul class="list-group list-group-flush small" id="listFailed"
                            style="max-height: 150px; overflow-y: auto;"></ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-primary" id="submitBulkImport">
                    <i class="bi bi-check"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Categories Modal -->
<div class="modal fade" id="manageCategoriesModal" tabindex="-1" aria-labelledby="manageCategoriesModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageCategoriesModalLabel">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- List of Categories -->
                <div class="mb-4">
                    <h6 class="mb-3">–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h6>
                    <div id="categoriesList" class="list-group">
                        <!-- Categories will be loaded here -->
                        <div class="text-center py-3 text-muted">
                            <div class="spinner-border spinner-border-sm" role="status"></div> –ó–∞–≥—Ä—É–∑–∫–∞...
                        </div>
                    </div>
                </div>

                <!-- Add New Category Form -->
                <div>
                    <h6 class="mb-3">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h6>
                    <form id="addCategoryForm" class="row g-2 align-items-end">
                        <div class="col-7">
                            <label for="newCategoryName" class="form-label small text-muted">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" class="form-control" id="newCategoryName"
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Production" required>
                        </div>
                        <div class="col-2">
                            <label for="newCategoryColor" class="form-label small text-muted">–¶–≤–µ—Ç</label>
                            <input type="color" class="form-control form-control-color w-100" id="newCategoryColor"
                                value="#0d6efd" title="–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç">
                        </div>
                        <div class="col-3">
                            <button type="submit" class="btn btn-primary w-100">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const serverModal = document.getElementById('serverModal');
        const passwordField = document.getElementById('password-field');
        const serverForm = document.getElementById('serverForm');
        const modalTitle = document.getElementById('serverModalLabel');

        serverModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const action = button.getAttribute('data-action');

            if (action === 'add') {
                modalTitle.textContent = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä';
                serverForm.action = button.getAttribute('data-add-url');
                passwordField.style.display = 'block';
                // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π
                serverForm.reset();
            } else if (action === 'edit') {
                modalTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä';
                const serverId = button.getAttribute('data-id');
                const serverRow = document.getElementById(`server-${serverId}`);

                // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã
                document.getElementById('server-name').value = serverRow.querySelector('[data-field="name"]').textContent;
                document.getElementById('server-ip').value = serverRow.querySelector('[data-field="ip_address"]').textContent;
                document.getElementById('server-port').value = serverRow.querySelector('[data-field="ssh_port"]').textContent;
                document.getElementById('server-username').value = serverRow.querySelector('[data-field="username"]').textContent;

                serverForm.action = `/api/servers/edit/${serverId}`;
                passwordField.style.display = 'none';
            }
        });

        const deleteModal = document.getElementById('deleteConfirmModal');
        let serverIdToDelete = null;

        deleteModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            serverIdToDelete = button.getAttribute('data-id');
            const serverName = button.getAttribute('data-name');
            deleteModal.querySelector('#serverNameToDelete').textContent = serverName;
        });

        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.addEventListener('click', async function () {
            if (!serverIdToDelete) return;

            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.')) {
                return;
            }

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            try {
                const response = await fetch(`/api/servers/delete/${serverIdToDelete}`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken
                    }
                });

                const data = await response.json();

                if (data.success) {
                    alert('‚úÖ ' + data.message);
                    document.getElementById(`server-${serverIdToDelete}`).remove();
                    bootstrap.Modal.getInstance(deleteModal).hide();
                } else {
                    alert('‚ùå ' + data.message);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞:', error);
                alert('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.');
            }
        });

        // Test Server Button Handler
        document.querySelectorAll('.test-btn').forEach(button => {
            button.addEventListener('click', async function () {
                const serverId = this.getAttribute('data-id');
                const btn = this;
                const originalHTML = btn.innerHTML;

                // Show loading spinner
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i>';

                try {
                    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                    const response = await fetch(`/api/servers/test/${serverId}`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    });

                    const data = await response.json();

                    if (data.success) {
                        // Update status badge in table
                        const statusCell = document.querySelector(`#server-${serverId} [data-field="status"]`);
                        if (statusCell) {
                            const badgeClass = data.status === 'online' ? 'bg-success' : 'bg-danger';
                            statusCell.innerHTML = `<span class="badge ${badgeClass}">${data.status}</span>`;
                        }

                        alert(`‚úÖ ${data.message}`);
                    } else {
                        alert(`‚ùå –û—à–∏–±–∫–∞: ${data.message}`);
                    }
                } catch (error) {
                    console.error('Test server error:', error);
                    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–µ—Ä–≤–µ—Ä–∞');
                } finally {
                    // Restore button
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                }
            });
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤
    document.getElementById('submitBulkImport').addEventListener('click', function () {
        const serversData = document.getElementById('bulkServersList').value.trim();
        const errorContainer = document.getElementById('importError');

        // –°–±—Ä–æ—Å –æ—à–∏–±–æ–∫
        errorContainer.style.display = 'none';
        errorContainer.textContent = '';

        if (!serversData) {
            errorContainer.textContent = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤';
            errorContainer.style.display = 'block';
            return;
        }

        // UI Elements
        const btn = document.getElementById('submitBulkImport');
        const cancelBtn = document.querySelector('#bulkImportModal .btn-secondary');
        const textarea = document.getElementById('bulkServersList');
        const instructions = document.getElementById('importInstructions');
        const resultsContainer = document.getElementById('importResults');

        const originalText = btn.innerHTML;

        // Disable UI
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
        textarea.disabled = true;

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å AJAX –∑–∞–ø—Ä–æ—Å
        fetch('/api/bulk-import-servers', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
                servers_data: serversData
            })
        })
            .then(response => response.json())
            .then(data => {
                btn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"

                // –ú–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–º–µ–Ω–∞" –Ω–∞ "–ó–∞–∫—Ä—ã—Ç—å" –∏ –¥–æ–±–∞–≤–ª—è–µ–º reload
                cancelBtn.innerHTML = '–ó–∞–∫—Ä—ã—Ç—å';
                cancelBtn.classList.remove('btn-secondary');
                cancelBtn.classList.add('btn-primary');
                cancelBtn.onclick = function () {
                    location.reload();
                };

                // –°–∫—Ä—ã–≤–∞–µ–º –≤–≤–æ–¥ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                textarea.style.display = 'none';
                instructions.style.display = 'none';
                resultsContainer.style.display = 'block';

                if (data.success) {
                    // Helper to create list items
                    const createListItem = (item, type) => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';

                        let content = `<div><strong>${item.name}</strong> <span class="text-muted">(${item.ip})</span></div>`;

                        if (type === 'failed' || type === 'skipped') {
                            content += `<span class="badge bg-light text-dark border">${item.reason}</span>`;
                        }

                        li.innerHTML = content;
                        return li;
                    };

                    // Process Added
                    const addedList = document.getElementById('listAdded');
                    document.getElementById('countAdded').textContent = data.added.length;
                    if (data.added.length > 0) {
                        document.getElementById('resultsAdded').style.display = 'block';
                        data.added.forEach(item => addedList.appendChild(createListItem(item, 'added')));
                    }

                    // Process Skipped
                    const skippedList = document.getElementById('listSkipped');
                    document.getElementById('countSkipped').textContent = data.skipped.length;
                    if (data.skipped.length > 0) {
                        document.getElementById('resultsSkipped').style.display = 'block';
                        data.skipped.forEach(item => skippedList.appendChild(createListItem(item, 'skipped')));
                    }

                    // Process Failed
                    const failedList = document.getElementById('listFailed');
                    document.getElementById('countFailed').textContent = data.failed.length;
                    if (data.failed.length > 0) {
                        document.getElementById('resultsFailed').style.display = 'block';
                        data.failed.forEach(item => failedList.appendChild(createListItem(item, 'failed')));
                    }

                } else {
                    // Fallback for general error
                    errorContainer.textContent = `‚ùå –û—à–∏–±–∫–∞: ${data.message}`;
                    errorContainer.style.display = 'block';
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = originalText;
                textarea.disabled = false;
                errorContainer.textContent = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${error}`;
                errorContainer.style.display = 'block';
            });
    }); // End of bulk import handler

    // --- Category Management Logic ---

    // Global functions for category management
    async function loadCategories() {
        const categoriesList = document.getElementById('categoriesList');
        if (!categoriesList) return;

        try {
            const response = await fetch('/api/categories');
            const categories = await response.json();

            categoriesList.innerHTML = '';

            if (categories.length === 0) {
                categoriesList.innerHTML = '<div class="list-group-item text-center text-muted">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
                return;
            }

            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: ${cat.color}; display: inline-block;"></span>
                        <span>${cat.name}</span>
                        <span class="badge bg-light text-dark ms-2 rounded-pill border">${cat.server_count || 0}</span>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cat.id})" title="–£–¥–∞–ª–∏—Ç—å">
                        <i class="bi bi-trash"></i>
                    </button>
                `;
                categoriesList.appendChild(item);
            });
        } catch (error) {
            console.error('Error loading categories:', error);
            categoriesList.innerHTML = '<div class="text-danger text-center">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>';
        }
    }

    async function createCategory() {
        const nameInput = document.getElementById('newCategoryName');
        const colorInput = document.getElementById('newCategoryColor');

        if (!nameInput || !colorInput) return;

        const name = nameInput.value.trim();
        const color = colorInput.value;

        if (!name) return;

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        try {
            const response = await fetch('/api/categories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ name, color })
            });

            if (response.ok) {
                nameInput.value = '';
                // Reload list
                loadCategories();
            } else {
                const data = await response.json();
                alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é'));
            }
        } catch (error) {
            console.error('Error creating category:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        }
    }

    // Make deleteCategory global explicitly
    window.deleteCategory = async function (id) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
            return;
        }

        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        try {
            const response = await fetch(`/api/categories/${id}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (response.ok) {
                loadCategories();
            } else {
                const data = await response.json();
                alert('–û—à–∏–±–∫–∞: ' + (data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é'));
            }
        } catch (error) {
            console.error('Error deleting category:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
        }
    };

    // Initialize Category Event Listeners
    document.addEventListener('DOMContentLoaded', function () {
        const manageCategoriesModal = document.getElementById('manageCategoriesModal');
        const addCategoryForm = document.getElementById('addCategoryForm');

        if (manageCategoriesModal) {
            // Load categories when modal opens
            manageCategoriesModal.addEventListener('show.bs.modal', function () {
                loadCategories();
            });
        }

        if (addCategoryForm) {
            // Handle Add Category
            addCategoryForm.addEventListener('submit', function (e) {
                e.preventDefault();
                createCategory();
            });
        }
    });
</script>
{% endblock %}